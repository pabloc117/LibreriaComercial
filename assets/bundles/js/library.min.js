"use strict";var app=angular.module("libraryApp",["ngRoute"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"app/layouts/catalogue/catalogue.html",controller:"catalogueController"}).when("/404",{templateUrl:"app/layouts/404/404.html"}).otherwise({redirectTo:"/"})}),app.filter("toDate",function(){return function(unix_timestamp){return new Date(1e3*unix_timestamp)}}).filter("toTimestamp",function(){return function(str){return new Date(str).getTime()/1e3}}).filter("validDate",function(){return function(date){return"Invalid Date"!==new Date(date)&&!isNaN(new Date(date))&&new Date(date)<new Date}}),app.filter("capitalize",function(){return function(input,char){if(isNaN(input)){for(var char=char-1||0,letter=input.charAt(char).toUpperCase(),out=[],i=0;i<input.length;i++)i==char?out.push(letter):out.push(input[i]);return out.join("")}return input}}).filter("removeAccents",function(){return function(source){if(""!=source&&null!=source)for(var accent=[/[\300-\306]/g,/[\340-\346]/g,/[\310-\313]/g,/[\350-\353]/g,/[\314-\317]/g,/[\354-\357]/g,/[\322-\330]/g,/[\362-\370]/g,/[\331-\334]/g,/[\371-\374]/g,/[\321]/g,/[\361]/g,/[\307]/g,/[\347]/g],noaccent=["A","a","E","e","I","i","O","o","U","u","N","n","C","c"],i=0;i<accent.length;i++)source=source.replace(accent[i],noaccent[i]);return source}}).filter("searchReplace",function(){return function(str,search,replace){return str=str||"",search=search||"",replace=replace||"",str.replace(new RegExp(search,"g"),replace)}}).filter("trim",function(){return function(str){return str.trim()}}).filter("empty",function(){return function(text){return void 0==text||""==text}}),app.directive("book",function(){return{templateUrl:"app/components/book/book.html",restrict:"E",replace:!0}}),app.directive("button",function(){return{replace:!0,restrict:"E",scope:{text:"@",classname:"@"},template:'<div class="buttonItem {{ classname }}">    <div class="display_table">        <div class="display_table_cell">            <span class="icon icon_base"></span>            <span class="text"> {{ text }} </span>        </div>    </div></div>'}}),app.directive("footer",function(){return{templateUrl:"app/components/footer/footer.html",replace:!0}}),app.directive("header",function(){return{templateUrl:"app/components/header/header.html",replace:!0}}),app.directive("searcher",function(){return{templateUrl:"app/components/searcher/searcher.html",controller:"searcherController",replace:!0}}),app.controller("searcherController",function($scope){const THEME_TYPE="theme",AUTHOR_TYPE="author";$scope.displaySearch=!1,$scope.searchType="",$scope.searchParams={title:"",author:"",ISBIN:"",theme:"",user:""},$scope.closeSearch=function(){""==$scope.searchType,$scope.restoreSearch()},$scope.restoreSearch=function(){""==$scope.searchType&&($scope.searchType="title"),$scope.books.forEach(function(book){book.display=!0}),$scope.searchParams={title:"",author:"",ISBIN:"",theme:"",user:""}},$scope.searchUser=function(){var display=!1;$scope.books.forEach(function(book){book.users.forEach(function(user){user.name==$scope.searchParams.user&&(display=!0)}),book.display=display,display=!1})},$scope.searchBook=function(){var matchTexts,searchTexts,result,display=!0,searchType=$scope.searchType.toLowerCase();$scope.books.forEach(function(book){result=$scope.getSearchParams(searchType,book,$scope.searchParams),matchTexts=result[0],searchTexts=result[1],matchTexts.forEach(function(matchText,k){(void 0==matchText||void 0==searchTexts[k]||""!=searchTexts[k]&&matchText.toLowerCase().indexOf(searchTexts[k])==-1)&&(display=!1)}),book.display=display,display=!0,matchTexts=[],searchTexts=[]})},$scope.getSearchParams=function(searchType,book,searchParams){var matchTexts=[],searchTexts=[];return searchType==AUTHOR_TYPE?(matchTexts.push(book.metadata.substr(18,20).toLowerCase().trim()),searchTexts.push(searchParams[THEME_TYPE].toLowerCase().trim()),matchTexts.push(book[searchType.toLowerCase()]),searchTexts.push(searchParams[searchType].toLowerCase().trim())):searchType==THEME_TYPE?(searchTexts.push(searchParams[AUTHOR_TYPE].toLowerCase().trim()),matchTexts.push(book.author.toLowerCase().trim()),matchTexts.push(book.metadata.substr(18,20).toLowerCase().trim()),searchTexts.push(searchParams[THEME_TYPE].toLowerCase().trim())):(matchTexts.push(book[searchType.toLowerCase()]),searchTexts.push(searchParams[searchType].toLowerCase().trim())),[matchTexts,searchTexts]}}),app.directive("user",function(){return{templateUrl:"app/components/user/user.html",replace:!0}}),app.filter("getIcon",function(){return function(str){var name=str.split(" ");return name[0].charAt(0)+name[1].charAt(0)}}),app.controller("catalogueController",function($scope,$location,catalogueService,toTimestampFilter,validDateFilter){$scope.books=[],$scope.users=[],catalogueService.getBooks().then(function(response){$scope.books=response.books,$scope.books.forEach(function(book){book.users.forEach(function(user){user.id in $scope.users||$scope.users.push(user.name)})})}).catch(function(){$location.path("/404")}),catalogueService.getThemes().then(function(response){$scope.themes=response}),window.addEventListener("beforeunload",function(e){var isEditedButNotSaved=!1;if($scope.books.forEach(function(book){book.edited&&!book.saved&&(isEditedButNotSaved=!0)}),isEditedButNotSaved){var confirmationMessage="o/";return(e||window.event).returnValue=confirmationMessage,confirmationMessage}return!0}),$scope.isvalidBook=function(book){if(""==book.title||""==book.author||""==book.date||""==book.theme||""==book.isbin)return"Revisa que no haya ninguno vacio";if(book.title.length<5||book.author.length<5)return"Título o autor demasiado corto";if(book.title.length>50||book.author.length>50)return"Título o autor demasiado largo";if(!validDateFilter(book.date))return"La fecha no es valida";var regex="[0-9]{3}-[0-9]-[0-9]{3}-[0-9]{5}-[0-9]",match=book.isbin.match(regex);return null==match||book.isbin!=match[0]?"El ISBIN no es valido xxx-x-xxx-xxxxx-x":""!=book.theme.length||"Debes seleccionar una tematica"},$scope.saveBook=function(book){var isValid=$scope.isvalidBook(book);return 1==isValid?(book.metadata=this.generateMetadata(book),catalogueService.saveBook(book),book.saved=!0,!1):(document.getElementById("errorMessage").innerHTML=isValid,book.valid=!1,!0)},$scope.generateMetadata=function(selectedBook){var paddingTheme=new Array(13).join(" ").substring(selectedBook.theme.length),timestamp=toTimestampFilter(selectedBook.date)+"",paddingTimestamp=new Array(16).join("0").substring(timestamp.length);return"L"+selectedBook.isbin+selectedBook.theme+paddingTheme+new Array(21).join(" ")+paddingTimestamp+timestamp},$scope.deleteBook=function(book,$index){$scope.books.splice($index,1),catalogueService.deleteBook(book)},$scope.addBook=function(){var book={title:"Nuevo libro",author:"Autor",metadata:"L000-0-000-00000-0                                000000000000000",users:[]};$scope.books.unshift(book)}}),app.service("catalogueService",function($q,$http){this.getBooks=function(){var defered=$q.defer(),promise=defered.promise;return $http.get("https://gist.githubusercontent.com/finizen/6f5d574cec11112342c552fe6fa64a8a/raw/68c755db1a3c255edc258b54176b98bb2b2e8d49/booksV1.json").then(function(data){defered.resolve(data.data)},function(err){defered.reject(err)}),promise},this.getThemes=function(){var defered=$q.defer(),promise=defered.promise;return $http.get("assets/mock/themes.json").then(function(data){defered.resolve(data.data)},function(err){defered.reject(err)}),promise},this.deleteBook=function(book){return console.log("the "+book.title+" "+book.author+" "+book.metadata+" has been deleted"),!0},this.saveBook=function(book){return console.log("the "+book.title+" "+book.author+" "+book.metadata+" has been edited and saved"),!0}});